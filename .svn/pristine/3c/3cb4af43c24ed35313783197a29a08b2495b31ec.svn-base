<%@page import="site.itwill.dto.OrderDetailDTO"%>
<%@page import="site.itwill.dto.CartDTO"%>
<%@page import="java.text.SimpleDateFormat"%>
<%@page import="java.util.Date"%>
<%@page import="site.itwill.dto.OrderDTO"%>
<%@page import="site.itwill.dao.OrderDAO"%>
<%@page import="java.util.ArrayList"%>
<%@page import="java.util.List"%>
<%@page import="site.itwill.dao.CartDAO"%>
<%@page import="site.itwill.dao.OrderDetailDAO"%>
<%@page import="site.itwill.dto.LushUserDTO"%>
<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%-- 장바구니 정보를 전달받아 주문상세 테이블에 저장하고 장바구니 삭제 처리페이지로 이동하는 JSP 문서 --%>
<%
	/* //비정상적인 요청에 대한 응답 처리
	if(request.getMethod().equals("GET")) {
		response.sendError(HttpServletResponse.SC_METHOD_NOT_ALLOWED);
		return;
	} */

	//POST 방식으로 요청되어 전달된 값들에 대한 캐릭터셋 변경
	request.setCharacterEncoding("UTF-8");

	//장바구니 정보 전달
	//상세번호 : 자동 증가값
	int detailNo=OrderDetailDAO.getOrderDAO().getDetailNum();

	//아이디 : 세션 공유 인증정보			
	LushUserDTO loginUser=(LushUserDTO)session.getAttribute("loginUser");
	String id=loginUser.getId();
	
	//주문번호 : getParameter		
	String orderNo=request.getParameter("orderNo");
	
	//상품코드 : 장바구니 테이블(세션)		int[] >> checkCartNo을 받아 for문으로 itemNo 추가
	String[] checkCartNo=(String[])session.getAttribute("checkCartNo");
	
	ArrayList<Integer> itemNoList=new ArrayList<Integer>();
	for(String cartNo:checkCartNo) {
		int itemNo=CartDAO.getCartDAO().getitemNo(Integer.parseInt(cartNo));
		itemNoList.add(itemNo);
	}
	
	
	//금액(합계금액) : 장바구니 테이블		int
	int totalPrice=(Integer)session.getAttribute("productSum");
	session.removeAttribute("productSum");
	
	
	//수량 : 장바구니 테이블(세션)			int[] >> checkCartNo을 받아 for문으로 volume 추가
	ArrayList<Integer> volumeList=new ArrayList<Integer>();
	for(String cartNo:checkCartNo) {
		CartDTO cart=CartDAO.getCartDAO().getCartInfo(Integer.parseInt(cartNo));
		int volume=cart.getVolume();
		volumeList.add(volume);
	}
	
	//주문날짜 : sysdate >> 전달 X
	
	for(int i=0;i<itemNoList.size();i++) {
		//DTO 인스턴스 생성 후 필드값 변경
		OrderDetailDTO detail=new OrderDetailDTO();
		detail.setDetailNo(detailNo);
		detail.setId(id);
		detail.setOrderNo(orderNo);
		detail.setItemNo(itemNoList.get(i));
		detail.setTotalPrice(totalPrice);
		detail.setVolume(volumeList.get(i));
		
		//변경한 값을 ORDER_DETAIL 테이블에 전달해 저장하는 DAO 클래스의 메소드 호출
		OrderDetailDAO.getOrderDAO().addOrderDetail(detail);
	}
	
	//주문 등록 처리페이지로 이동
	response.sendRedirect(request.getContextPath()+"/order/cart_remove_action.jsp");
%>



















