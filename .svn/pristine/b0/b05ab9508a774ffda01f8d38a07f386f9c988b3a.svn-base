<%@page import="site.itwill.dao.ProductDAO"%>
<%@page import="java.text.DecimalFormat"%>
<%@page import="site.itwill.dto.ProductDTO"%>
<%@page import="site.itwill.dao.CartDAO"%>
<%@page import="java.util.List"%>
<%@page import="site.itwill.dto.CartDTO"%>
<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@include file="/security/login_status.jspf" %>
<%
	//POST 방식으로 요청되어 전달된 값들에 대한 캐릭터셋 변경
	request.setCharacterEncoding("UTF-8");
 
	List<CartDTO> cartList=CartDAO.getCartDAO().getCartList(loginUser.getId());
	int num=CartDAO.getCartDAO().getCartNumber(loginUser.getId());
	
	//총 상품 금액을 출력하기 위한 변수 생성
	int sum=0;
%>
<link href="https://fonts.googleapis.com/css?family=Noto+Sans+KR&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Anton|Archivo+Black&display=swap" rel="stylesheet">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<style type="text/css">
body {
	color: #000000;
	font-family: "Noto Sans KR";
	font-size: 14px;
	line-height: 1.4;
	letter-spacing: -0.5px;
}
#shoppingCart {
	font-family: 'Archivo Black', sans-serif;
	text-align: center;
	font-size: 42px;
	margin-top: 90px;
}
#noItem {
	width: 1180px;
	height: 170px;
    text-align: center;
    font-size: 22px;
    color: #333;
    border-top: none;
}
#cooc {
	text-align: center;
	margin-top: 30px;
	margin-bottom: 90px;
}
tr>th {
	margin: 15px 0;
	height: 48px;
	color: #8f8f8f;
	font-weight: normal;
	font-size: 14px;
	text-align: center;
}
tr>td {
	height: 156px;
	border-top: 1px solid #e7e7e7;
	text-align: center;
}
#itemName {
	margin-top: 45px;
	font-size: 20px;
}
.btn {
	padding-top: 2px;
	text-align: center;
	text-decoration: none;
	display: inline-block;
	color: black;
	font-size: 18px;
	width: 38px;
	height: 35px;
	background: none;
	border: 1px solid #e7e7e7;
	
}

.btn:hover {
	cursor: pointer;
}
#volInput {
	width: 44px;
	text-align: center;
	border: none;
	font-size: 18px;
}
.priceInput {
	border: none;
	text-align: center;
	font-size: 18px;
	font-weight: bold;
}
.totalPrice {
	background: rgb(240, 240, 240);
	text-align: center;
	font-size: 20px;
}
.totalPriceInput {
	border: none;
	background: rgb(240, 240, 240);
}
#deleteBtn {
	font-family: "Noto Sans KR";
	font-size: 13px;
	font-weight: bold;
	margin-top: 20px;
	background: none;
	border: none;
	outline: none;
	border-bottom: 1px solid ;
}
#bottomBtn {
	margin-top: 50px;
	margin-bottom: 100px;
	text-align: center;
	
}
#deleteBtn,#itemCheck,#continueShopping,#getOrder:hover {
	cursor: pointer;	
}
#message {
	margin-left: 10px;
	color: blue;
	font-weight: bold;
}
*:focus {
    outline: none;
}

</style>
<form name="cartForm" id="cartForm" style="width: 1180px; margin: 0 auto;">
	<input type="hidden" name="id" value="<%=loginUser.getId()%>"> 
	<h2 id="shoppingCart">SHOPPING CART</h2>
	<h4 id="cooc" style="color: rgb(168, 168, 168); font-size: 15px;">
		<span id="order" style="color: #333">Cart</span>&nbsp;&nbsp;&nbsp;&nbsp;>&nbsp;&nbsp;&nbsp;&nbsp; Order
		&nbsp;&nbsp;&nbsp;&nbsp;>&nbsp;&nbsp;&nbsp;&nbsp;Order confirmed</h4>
	<h1>제품</h1>
	<div style="border-top: 1px solid #000; border-bottom: 0.5px solid #e7e7e7;">
		<table id="item">
			<% if(cartList.size()==0) { %>
				<tr>
					<td colspan="5" id="noItem">장바구니에 담겨있는 상품이 없습니다.</td>
				</tr>
			<% } else { %>
				<tr id="itemTitle">
					<th><input type="checkbox" name="itemAllCheck" id="itemAllCheck" style="text-align: left;" checked="checked"></th>
					<th class="cart_name">제품 정보</th>
					<th class="cart_volume">수량</th>
					<th class="cart_price">금액</th>
					<th class="cart_totalPrice">합계금액</th>
				</tr>

				<% for(CartDTO cart:cartList) { %>
				<% //상품코드에 해당하는 상품정보 DTO 생성
				   ProductDTO item=ProductDAO.getDAO().getProduct2(cart.getItemNo());
				%>
					<tr>
						<td class="cart_check"><input type="checkbox" name="checkCartNo" value="<%=cart.getCartNo()%>" class="check" checked="checked"></td>
						<td class="cart_name">
							<div>
								<img src="<%=request.getContextPath()%>/admin/product_image/<%=item.getImage()%>" alt="<%=item.getName()%>" style="width: 115px; height: 115px;">
								<div style="display: inline-block; height: 33px; padding: 40px;">
									<a id="itemName" href="<%=request.getContextPath()%>/index.jsp?workgroup=rush&work=product_detailpage&name=<%=item.getName()%>"><%=item.getName()%></a>
								</div>
							</div>
						</td>
						<td class="cart_volume">
						<% if(cart.getVolume()==1) { %>
							<a id="minusBtn" class="btn">-</a>
						<% } else { %>
							<a id="minusBtn" class="btn" href="<%=request.getContextPath()%>/cart/cart_modify_action.jsp?btnStatus=0&cartNo=<%=cart.getCartNo()%>">-</a>
						<% } %>
							<input type="text" id="volInput" value="<%=cart.getVolume() %>" readonly="readonly">
							<a id="plusBtn" class="btn" href="<%=request.getContextPath()%>/cart/cart_modify_action.jsp?btnStatus=1&cartNo=<%=cart.getCartNo()%>">+</a>
						</td>
						<td class="cart_price">
							<input type="text" name="cartPrice" class="priceInput" value="<%=DecimalFormat.getInstance().format(cart.getPrice()) %>" readonly="readonly">
						</td>
						<td class="cart_totalPrice">
							<input type="text" name="cartTotalPrice" id="<%=cart.getCartNo() %>" class="priceInput" value="<%=DecimalFormat.getInstance().format(cart.getTotalPrice()) %>" readonly="readonly">
							<% sum+=cart.getTotalPrice();%>
							</td>
					</tr>
				<% } %>
			<% } %>
		</table>
	</div>
	<div class="totalPrice" style="padding: 30px; font-size: 18px;">
		총 <input type="text" name="itemNum" class="totalPriceInput" readonly="readonly" style="width: 20px; text-align: center; font-size: 18px;">개의 상품 금액 
		&nbsp;&nbsp;&nbsp;=&nbsp;&nbsp;
		<input type="text" name="totalPrice" style="font-weight: bold; font-size: 26px; width: 100px; text-align: center;" class="totalPriceInput" readonly="readonly" value="<%=sum%>">
		&nbsp;&nbsp;원
	</div>
	<div>
		<button type="button" id="deleteBtn" onclick="deleteConfirm();">삭제 하기</button>
		<a id="message"></a>
	</div>
	<div id="bottomBtn">
		<button type="button" name="continueShopping" id="continueShopping" 
			    onclick="location.href='<%=request.getContextPath()%>/index.jsp?workgroup=rush&work=bath'">쇼핑 계속하기</button>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		<button type="button" name="getOrder" id="getOrder" onclick="orderConfirm();">주문하기</button>
	</div>
</form>
	
<script type="text/javascript">
$("#bottomBtn").children("#continueShopping").css({"width":250,"height":60,"background":"white","color":"black","font-size":"15px","border":"solid 0.5px black","font-weight":"bold"});
$("#bottomBtn").children("#getOrder").css({"width":250,"height":60,"background":"black","color":"white","font-size":"15px","border":"none","font-weight":"bold"});
$(".cart_check").css("width",70);
$(".cart_name").css("width",480);
$(".cart_volume").css("width",230);
$(".cart_price").css("width",200);
$(".cart_totalPrice").css("width",203);

//체크박스에 대한 변수 생성
var allCheckNum=$("input:checkbox[name=checkCartNo]").length;
var checkNum=allCheckNum;
var price=<%=sum%>;

//전체 체크박스 클릭했을 때
$("#itemAllCheck").change(function() {
	if($(this).is(":checked")) {
		$(".check").prop("checked",true);
		checkNum=allCheckNum;
		price=<%=sum%>;
	} else {
		$(".check").prop("checked",false);
		checkNum=0;
		price=0;
	}
	cartForm.itemNum.value=checkNum;	
	cartForm.totalPrice.value=price;
});

//상품 체크박스 클릭했을 때
$(".check").change(function() {
	if($(this).is(":checked")) {
		checkNum++;
		var cartNo=$(this).val();
		price=parseInt(price)+parseInt($("#"+cartNo).val().replace(",", ""));
	} else {
		cartForm.itemAllCheck.checked=false;
		checkNum--;
		var cartNo=$(this).val();
		price=parseInt(price)-$("#"+cartNo).val().replace(",", "");
	}
	cartForm.itemNum.value=checkNum;
	cartForm.totalPrice.value=price;
});

cartForm.itemNum.value=$("input:checkbox[name=checkCartNo]").length;

//volume 이 0이하로 내려갈 경우 잘못된 수량이라는 alert 출력 후 1로 수량 변경 
$("#minusBtn").click(function() {
	if(volInput.val()<=0) {
		alert("상품 수량 이상으로 장바구니에 해당 상품을 담을 수 없습니다.");
		cartForm.volInput.value="1";		
	}
});

function orderConfirm() {
	if(confirm("선택하신 상품을 주문합니다.")) {
		if($(".check").filter(":checked").size()==0) {
			$("#message").text("주문하실 상품을 체크해 주세요.");
			return;
		}
		
		$("#cartForm").attr("method","post");
		$("#cartForm").attr("action","<%=request.getContextPath()%>/index.jsp?workgroup=order&work=order_write");
		$("#cartForm").submit();
	}
}

function deleteConfirm() {
	if(confirm("선택하신 상품을 장바구니에서 삭제 하시겠습니까?")) {
		if($(".check").filter(":checked").size()==0) {
			$("#message").text("삭제하실 상품을 체크해 주세요.");
			return;
		}
		
		$("#cartForm").attr("method","post");
		$("#cartForm").attr("action","<%=request.getContextPath()%>/cart/cart_remove_action.jsp");
		$("#cartForm").submit();

	}
};
</script>