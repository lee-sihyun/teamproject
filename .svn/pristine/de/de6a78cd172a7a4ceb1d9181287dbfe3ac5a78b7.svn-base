package site.itwill.dao;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;

import site.itwill.dto.ReviewDTO;
import site.itwill.dto.ReviewDTO;

public class ReviewDAO extends JdbcDAO {
	private static ReviewDAO _dao;

	public ReviewDAO() {
		// TODO Auto-generated constructor stub
	}

	static {
		_dao = new ReviewDAO();
	}

	public static ReviewDAO getDAO() {
		return _dao;
	}

	// => 검색대상이 없는 경우 Review 테이블에 저장된 전체 게시글의 갯수를 검색하여 반환하는 메소드
	public int getReviewTotal() {
		Connection con = null;
		PreparedStatement pstmt = null;
		ResultSet rs = null;
		int rows = 0;
		try {
			con = getConnection();
			String sql = "select count(*) from Review";
			pstmt = con.prepareStatement(sql);

			rs = pstmt.executeQuery();

			if (rs.next()) {
				rows = rs.getInt(1);
			}

		} catch (SQLException e) {
			System.out.println("[에러]getReviewTotal() 메소드의 SQL 오류 = " + e.getMessage());
		} finally {
			close(con, pstmt, rs);
		}
		return rows;
	}

	// Review_SEQ 시퀸스의 자동 증가값을 검색하여 반환하는 메소드
	public int getReviewNum() {
		Connection con = null;
		PreparedStatement pstmt = null;
		ResultSet rs = null;
		int num = 0;
		try {
			con = getConnection();

			String sql = "select Review_seq.nextval from dual";
			pstmt = con.prepareStatement(sql);

			rs = pstmt.executeQuery();

			if (rs.next()) {
				num = rs.getInt(1);
			}
		} catch (SQLException e) {
			System.out.println("[에러]getReviewNum() 메소드의 SQL 오류 = " + e.getMessage());
		} finally {
			close(con, pstmt, rs);
		}
		return num;
	}

	// 게시글 정보를 전달받아 Review 테이블에 저장하고 저장행의 갯수를 반환하는 메소드
	public int addReview(ReviewDTO Review) {
		Connection con = null;
		PreparedStatement pstmt = null;
		int rows = 0;
		try {
			con = getConnection();

			String sql = "insert into Review values(Review_SEQ.NEXTVAL,?,?,?,?,SYSDATE,?)";
			pstmt = con.prepareStatement(sql);
			pstmt.setString(1, Review.getRating());
			pstmt.setInt(2,	Review.getItem());
			pstmt.setString(2, Review.getContent());
			pstmt.setString(3, Review.getCategory());
			pstmt.setString(4, Review.getName());
			pstmt.setInt(5, Review.getStatus());

			rows = pstmt.executeUpdate();
		} catch (SQLException e) {
			System.out.println("[에러]addReview() 메소드의 SQL 오류 = " + e.getMessage());
		} finally {
			close(con, pstmt);
		}
		return rows;
	}

	// 게시글 번호를 전달받아 Review 테이블에 저장된 게시글을 검색하여 반환하는 메소드
	public ReviewDTO getReview(int num) {
		Connection con = null;
		PreparedStatement pstmt = null;
		ResultSet rs = null;
		ReviewDTO Review = null;
		try {
			con = getConnection();

			String sql = "select * from Review where num=?";
			pstmt = con.prepareStatement(sql);
			pstmt.setInt(1, num);

			rs = pstmt.executeQuery();

			if (rs.next()) {
				Review = new ReviewDTO();
				Review.setNum(rs.getInt("num"));
				Review.setRating(rs.getString("Rating"));
				Review.setItem(rs.getInt("item"));
				Review.setContent(rs.getString("content"));
				Review.setRegDate(rs.getString("reg_date"));
				Review.setName(rs.getString("name"));
				Review.setStatus(rs.getInt("status"));
			}
		} catch (SQLException e) {
			System.out.println("[에러]getReview() 메소드의 SQL 오류 = " + e.getMessage());
		} finally {
			close(con, pstmt, rs);
		}
		return Review;
	}

	// 게시글 번호를 전달받아 Review 테이블에 저장된 게시글을 삭제 처리하고 변경행의 갯수를 반환하는 메소드
	public int removeReview(int num) {
		Connection con = null;
		PreparedStatement pstmt = null;
		int rows = 0;
		try {
			con = getConnection();

			String sql = "update Review set status=9 where num=?";
			pstmt = con.prepareStatement(sql);
			pstmt.setInt(1, num);

			rows = pstmt.executeUpdate();
		} catch (SQLException e) {
			System.out.println("[에러]removeReview() 메소드의 SQL 오류 = " + e.getMessage());
		} finally {
			close(con, pstmt);
		}
		return rows;
	}

	// 게시글을 전달받아 Review 테이블에 저장된 게시글을 변경하고 변경행의 갯수를 반환하는 메소드
	public int modifyReview(ReviewDTO Review) {
		Connection con = null;
		PreparedStatement pstmt = null;
		int rows = 0;
		try {
			con = getConnection();

			String sql = "update Review set rating=?,content=? where num=?";
			pstmt = con.prepareStatement(sql);
			pstmt.setString(1, Review.getRating());
			pstmt.setString(2, Review.getContent());
			pstmt.setInt(3, Review.getNum());

			rows = pstmt.executeUpdate();
		} catch (SQLException e) {
			System.out.println("[에러]modifyReview() 메소드의 SQL 오류 = " + e.getMessage());
		} finally {
			close(con, pstmt);
		}
		return rows;
	}
}
