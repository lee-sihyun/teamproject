<%@page import="site.itwill.dao.ProductDAO"%>
<%@page import="site.itwill.dto.ProductDTO"%>
<%@page import="site.itwill.dto.LushUserDTO"%>
<%@page import="java.util.List"%>
<%@page import="site.itwill.dao.CartDAO"%>
<%@page import="site.itwill.dto.CartDTO"%>
<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@include file="/security/login_status2.jspf" %>
<%-- 상품페이지에서 상품정보를 전달받아 CART 테이블에 저장하고 출력페이지로 이동 --%>
<%-- => 1. 상품 >> 주문 일 경우 처리페이지 = order_write.jsp  --%>
<%-- => 2. 상품 >> 장바구니일 경우 처리페이지 = 상품페이지 + 장바구니바로이동? 의 confirm 생성 --%>
<%
	//POST 방식으로 요청되어 전달된 값들에 대한 캐릭터셋 변경
	request.setCharacterEncoding("UTF-8");

	//CART 테이블에 저장하기 위해 전달받은 값들을 반환받아 저장
	//장바구니번호 : 자동증가값 : 전달 X
	
	//아이디 : 세션으로 공유된 인증정보를 반환받아 저장
	String id=loginUser.getId();

	//상품코드 : 상품페이지에서 getParameter
	System.out.println(request.getParameter("itemNo"));
	int itemNo=Integer.parseInt(request.getParameter("itemNo"));

	//수량 : 상품페이지에서 getParameter
	int volume=Integer.parseInt(request.getParameter("amount"));

	//금액 : itemNo로 상품정보 DTO 생성 후 가격 가져오기
	ProductDTO item=ProductDAO.getDAO().getProduct2(itemNo);
	int price=item.getPrice();

	//합계금액 : 수량 * 금액 : 전달 X
	
	//추가할 상품이 이미 장바구니에 존재한다면 추가하지 않고 수량만 추가
	//장바구니 목록을 가져와 itemNo 를 비교
	//만약 해당 아이디의 장바구니 갯수가 0개라면 바로 추가
	List<CartDTO> cartList=CartDAO.getCartDAO().getCartList(id);
	CartDTO cart1=new CartDTO();
	if(cartList.size()==0) {
		//cartList 의 마지막 cart의 itemNo 이 변수 item_No 와 같지 않을 경우
		//CART 테이블의 cart_no 컬럼에 저장할 자동증가값을 생성하는 DAO 클래스의 메소드 호출 
		int num=CartDAO.getCartDAO().getCartNum();
		
		//DTO 인스턴스 생성 후 필드값 변경
		cart1.setCartNo(num);
		cart1.setId(id);
		cart1.setItemNo(itemNo);
		cart1.setVolume(volume);
		cart1.setPrice(price);
		cart1.setTotalPrice(volume*price);
		
		//변경한 값을 CART 테이블에 전달해 저장하는 DAO 클래스의 메소드 호출
		CartDAO.getCartDAO().addCart(cart1);
	} else {
		for(CartDTO cart:cartList) {
			if(itemNo==cart.getItemNo()) {
				CartDAO.getCartDAO().addVolume(volume, cart.getCartNo());
				break;
			} else if(cartList.indexOf(cart)==cartList.size()-1 && itemNo!=cart.getItemNo()) { 
				//cartList 의 마지막 cart의 itemNo 이 변수 item_No 와 같지 않을 경우
				//CART 테이블의 cart_no 컬럼에 저장할 자동증가값을 생성하는 DAO 클래스의 메소드 호출 
				int num=CartDAO.getCartDAO().getCartNum();
				
				//DTO 인스턴스 생성 후 필드값 변경
				cart1.setCartNo(num);
				cart1.setId(id);
				cart1.setItemNo(itemNo);
				cart1.setVolume(volume);
				cart1.setPrice(price);
				cart1.setTotalPrice(volume*price);
				
				//변경한 값을 CART 테이블에 전달해 저장하는 DAO 클래스의 메소드 호출
				CartDAO.getCartDAO().addCart(cart1);
			} else {
				continue;
			}
		}
	}

	//출력페이지로 이동
	response.sendRedirect(request.getContextPath()+"/index.jsp?workgroup=cart&work=cart_list");
	
%>
















